{% extends "base.html" %}

{% block content %}
<div class="container py-5">
  <h2 class="mb-4">üìù Edit Order #{{ order.id }}</h2>

  <form method="post">
    {% csrf_token %}
    <!-- ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ£Ÿàÿ±ÿØÿ± ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿäÿ© -->
    {{ form.as_p }}

    <h3>Order Items</h3>
    {{ formset.management_form }}

    <table id="order-items" class="table table-bordered">
      <thead>
        <tr>
          <th>Menu Item</th>
          <th>Quantity</th>
          <th>Delete?</th>
        </tr>
      </thead>
      <tbody>
        {% for f in formset %}
        <tr class="order-item-form">
          <td>{{ f.menuitem }}</td>
          <td>{{ f.quantity }}</td>
          <td>
            {% if f.instance.pk %}
              {{ f.DELETE }} Delete
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <!-- ŸÅŸàÿ±ŸÖ ŸÅÿßÿ∂Ÿä ŸÜÿ≥ÿ™ÿÆÿØŸÖŸá ŸÉŸÄ template -->
    <table style="display:none;">
      <tr id="empty-form" class="order-item-form">
        <td>{{ formset.empty_form.menuitem }}</td>
        <td>{{ formset.empty_form.quantity }}</td>
        <td></td>
      </tr>
    </table>

    <button type="button" id="add-item" class="btn btn-info">‚ûï Add another item</button>
    <br><br>
    <button type="submit" class="btn btn-success">üíæ Save Changes</button>
    <a href="{% url 'orders_list' %}" class="btn btn-secondary">Cancel</a>
  </form>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const addButton = document.getElementById("add-item");
    const formsetTable = document.getElementById("order-items").querySelector("tbody");

    // ‚úÖ ŸÜÿ¨Ÿäÿ® ÿßŸÑŸÄ prefix ŸÖŸÜ ÿ£Ÿä input hidden ÿ¨ŸàŸá management form
    const managementForm = document.querySelector("[name$='-TOTAL_FORMS']");
    const prefix = managementForm.name.replace("-TOTAL_FORMS", "");
    const totalForms = managementForm;

    addButton.addEventListener("click", function() {
        let formIndex = parseInt(totalForms.value);
        let newFormHtml = document.getElementById("empty-form").outerHTML.replace(/__prefix__/g, formIndex);
        
        // ŸÜÿ≠ŸàŸÑ ÿßŸÑŸÄ string ŸÑÿπŸÜÿµÿ±
        let tempDiv = document.createElement("tbody");
        tempDiv.innerHTML = newFormHtml;
        let newRow = tempDiv.firstElementChild;

        // reset values
        newRow.querySelectorAll("input, select").forEach(el => {
            if (el.tagName === "INPUT") el.value = (el.type === "number") ? 1 : "";
        });

        formsetTable.appendChild(newRow);
        totalForms.value = formIndex + 1;
    });
});
</script>
{% endblock %}
