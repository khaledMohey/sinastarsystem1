{% extends "base.html" %}
{% block content %}

<div class="container py-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold">ğŸ“Š Monthly Closings</h2>
        <a href="{% url 'create_monthly_closing' %}" class="btn btn-primary">â• Create Closing</a>
    </div>

    <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù€ Summary -->
    <div class="card shadow p-3 mb-4">
        <h4 class="fw-bold mb-3">ğŸ“‘ Closings Summary</h4>
        <table class="table table-striped table-bordered text-center">
            <thead class="table-dark">
                <tr>
                    <th>From</th>
                    <th>To</th>
                    <th>Ø§Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ø§Ø¹ (Ø§Ù„Ø§ÙˆØ±Ø¯Ø±Ø§Øª)</th>
                    <th>Ø³Ø¹Ø± Ø¨ÙŠØ¹ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ ÙÙ„Ù…Ø®Ø²Ù† (Ø§Ù„Ù…Ø®Ø²Ù†)</th>
                    <th>Ø§Ø¬Ù…Ø§Ù„ÙŠ Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ (history)</th>
                    <th>Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„Ø§Ø¬Ù…Ø§Ù„ÙŠ</th>
                    <th>Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù„Ùˆ Ø¨Ø¹Øª Ø§Ù„Ù…Ø®Ø²Ù†</th>
                    <th>Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„ÙØ¹Ù„ÙŠ</th>
                    <th>ØªÙˆØªØ§Ù„ Ø§Ù„Ù†Ø³Ø±ÙŠØ§Øª</th>   <!-- Ø¬Ø¯ÙŠØ¯ -->
                    <th>ØªÙˆØªØ§Ù„ Ø§Ù„ØªØ¨Ø³</th>      <!-- Ø¬Ø¯ÙŠØ¯ -->
                    <th>Created At</th>
                </tr>
            </thead>
            <tbody>
                {% for closing in closings %}
                <tr>
                    <td>{{ closing.start_date|date:"d M Y" }}</td>
                    <td>{{ closing.end_date|date:"d M Y" }}</td>
                    <td>{{ closing.total_sales_orders }}</td>
                    <td>{{ closing.total_sales_inventory }}</td>
                    <td>{{ closing.total_purchase_inventory }}</td>
                    <td>{{ closing.total_profit }}</td>
                    <td>{{ closing.profit_from_inventory }}</td>
                    <td>{{ closing.actual_profit }}</td>
                    <td>{{ closing.total_nesrayat }}</td>   <!-- Ø¬Ø¯ÙŠØ¯ -->
                    <td>{{ closing.total_tips }}</td>       <!-- Ø¬Ø¯ÙŠØ¯ -->
                    <td>{{ closing.created_at|date:"d M Y H:i" }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="11" class="text-muted">No closings found</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø²ÙŠ Ù…Ø§ Ù‡ÙŠ -->
    <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…Ø¨Ø§Ø¹Ø© -->
    <div class="card shadow p-3 mt-5">
        <h4 class="fw-bold mb-3">ğŸ“¦ Sold Materials (Ù…Ù† Ø§Ù„Ù…Ø®Ø²Ù†)</h4>
        <form method="get" class="mb-3 d-flex gap-2">
            <input type="date" name="sold_start" value="{{ sold_start }}" class="form-control" style="max-width:200px;">
            <input type="date" name="sold_end" value="{{ sold_end }}" class="form-control" style="max-width:200px;">
            <button type="submit" class="btn btn-primary">ğŸ” Filter</button>
            <a href="{% url 'monthly_closing_list' %}" class="btn btn-secondary">â™»ï¸ Reset</a>
        </form>
        <table class="table table-striped table-bordered text-center">
            <thead class="table-dark">
                <tr>
                    <th>Material</th>
                    <th>Quantity</th>
                    <th>Addition</th>
                    <th>Addition Cost</th>
                    <th>Purchase Price</th>
                    <th>Total Sale Price</th>
                    <th>Total Purchase Price</th>
                    <th>Profit</th>
                    <th>Type</th>
                    <th>Created At</th>
                </tr>
            </thead>
            <tbody>
                {% for item in sold_history %}
                <tr>
                    <td>{{ item.material.name }}</td>
                    <td>{{ item.quantity }}</td>
                    <td>{{ item.addition }}</td>
                    <td>{{ item.addition_cost }}</td>
                    <td>{{ item.purchase_price }}</td>
                    <td>{{ item.total_sale_price }}</td>
                    <td>{{ item.total_purchase_price }}</td>
                    <td>{{ item.profit }}</td>
                    <td>{{ item.type }}</td>
                    <td>{{ item.created_at|date:"d M Y H:i" }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="10" class="text-muted">No sold materials found</td>
                </tr>
                {% endfor %}
            </tbody>
            <tfoot class="table-secondary fw-bold">
                <tr>
                    <td>Totals</td>
                    <td>{{ total_quantity }}</td>
                    <td>{{ total_addition }}</td>
                    <td>-</td>
                    <td>-</td>
                    <td>{{ total_sale }}</td>
                    <td>{{ total_purchase }}</td>
                    <td>{{ total_profit }}</td>
                    <td colspan="2"></td>
                </tr>
            </tfoot>
        </table>
    </div>

    <!-- Ø¬Ø¯ÙˆÙ„ SinastarInventoryHistory -->
    <div class="card shadow p-3 mt-5">
        <h4 class="fw-bold mb-3">ğŸ“œ Sinastar Inventory History</h4>
        <form method="get" class="mb-3 d-flex gap-2">
            <input type="date" name="inv_start" value="{{ inv_start }}" class="form-control" style="max-width:200px;">
            <input type="date" name="inv_end" value="{{ inv_end }}" class="form-control" style="max-width:200px;">
            <button type="submit" class="btn btn-primary">ğŸ” Filter</button>
            <a href="{% url 'monthly_closing_list' %}" class="btn btn-secondary">â™»ï¸ Reset</a>
        </form>
        <table class="table table-bordered text-center">
            <thead class="table-dark">
                <tr>
                    <th>Material</th>
                    <th>Type</th>
                    <th>Quantity</th>
                    <th>Addition</th>
                    <th>Sale Price (per unit)</th>
                    <th>Purchase Price (per unit)</th>
                    <th>Total Sale</th>
                    <th>Total Purchase</th>
                    <th>Profit</th>
                    <th>Created At</th>
                </tr>
            </thead>
            <tbody>
                {% for item in inventory_history %}
                <tr>
                    <td>{{ item.material.name }}</td>
                    <td>{{ item.type }}</td>
                    <td>{{ item.quantity }}</td>
                    <td>{{ item.addition }}</td>
                    <td>{{ item.addition_cost }}</td>
                    <td>{{ item.purchase_price }}</td>
                    <td>{{ item.total_sale_price }}</td>
                    <td>{{ item.total_purchase_price }}</td>
                    <td>{{ item.profit }}</td>
                    <td>{{ item.created_at|date:"d M Y H:i" }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="10" class="text-muted">No history found</td>
                </tr>
                {% endfor %}
            </tbody>
            <tfoot class="table-secondary fw-bold">
                <tr>
                    <td colspan="6">Totals</td>
                    <td>{{ updated_total_sum }}</td>
                    <td>{{ total_purchase_sum }}</td>
                    <td>{{ total_profit_sum }}</td>
                    <td>-</td>
                </tr>
            </tfoot>
        </table>
    </div>

    <!-- Ø¬Ø¯ÙˆÙ„ SinastarInventory (Ø§Ù„Ù…Ø®Ø²Ù† Ø§Ù„Ø­Ø§Ù„ÙŠ) -->
    <div class="card shadow p-3 mt-5">
        <h4 class="fw-bold mb-3">ğŸ¬ Current Sinastar Inventory</h4>
        <form method="get" class="mb-3 d-flex gap-2">
            <input type="date" name="store_start" value="{{ store_start }}" class="form-control" style="max-width:200px;">
            <input type="date" name="store_end" value="{{ store_end }}" class="form-control" style="max-width:200px;">
            <button type="submit" class="btn btn-primary">ğŸ” Filter</button>
            <a href="{% url 'monthly_closing_list' %}" class="btn btn-secondary">â™»ï¸ Reset</a>
        </form>
        <table class="table table-bordered text-center">
            <thead class="table-dark">
                <tr>
                    <th>Material</th>
                    <th>Type</th>
                    <th>Quantity</th>
                    <th>Addition</th>
                    <th>Sale Price (per unit)</th>
                    <th>Purchase Price (per unit)</th>
                    <th>Total Sale</th>
                    <th>Total Purchase</th>
                    <th>Profit</th>
                    <th>Updated At</th>
                </tr>
            </thead>
            <tbody>
                {% for item in current_inventory %}
                <tr>
                    <td>{{ item.material.name }}</td>
                    <td>{{ item.type }}</td>
                    <td>{{ item.quantity }}</td>
                    <td>{{ item.addition }}</td>
                    <td>{{ item.addition_cost }}</td>
                    <td>{{ item.purchase_price }}</td>
                    <td>{{ item.total_sale_price }}</td>
                    <td>{{ item.total_purchase_price }}</td>
                    <td>{{ item.profit }}</td>
                    <td>{{ item.updated_at|date:"d M Y H:i" }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="10" class="text-muted">No inventory found</td>
                </tr>
                {% endfor %}
            </tbody>
            <tfoot class="table-secondary fw-bold">
                <tr>
                    <td colspan="6">Totals</td>
                    <td>{{ store_total_sale }}</td>
                    <td>{{ store_total_purchase }}</td>
                    <td>{{ store_total_profit }}</td>
                    <td>-</td>
                </tr>
            </tfoot>
        </table>
    </div>

    <!-- Ø¬Ø¯ÙˆÙ„ Orders -->
    <div class="card shadow p-3 mt-5">
        <h4 class="fw-bold mb-3">ğŸ§¾ Orders</h4>
        <form method="get" class="mb-3 d-flex gap-2">
            <input type="date" name="order_start" value="{{ order_start }}" class="form-control" style="max-width:200px;">
            <input type="date" name="order_end" value="{{ order_end }}" class="form-control" style="max-width:200px;">
            <button type="submit" class="btn btn-primary">ğŸ” Filter</button>
            <a href="{% url 'monthly_closing_list' %}" class="btn btn-secondary">â™»ï¸ Reset</a>
        </form>
        <table class="table table-striped table-bordered text-center">
            <thead class="table-dark">
                <tr>
                    <th>ID</th>
                    <th>Type</th>
                    <th>Cashier</th>
                    <th>Status</th>
                    <th>Total</th>
                    <th>Created At</th>
                </tr>
            </thead>
            <tbody>
                {% for order in orders %}
                <tr>
                    <td>#{{ order.id }}</td>
                    <td>{{ order.order_type }}</td>
                    <td>{% if order.cashier %} {{ order.cashier.username }} {% else %}-{% endif %}</td>
                    <td>
                        {% if order.is_paid %}
                            <span class="badge bg-success">Paid</span>
                        {% else %}
                            <span class="badge bg-danger">Unpaid</span>
                        {% endif %}
                    </td>
                    <td>{{ order.get_total }}</td>
                    <td>{{ order.created_at|date:"d M Y H:i" }}</td>
                </tr>
                {% empty %}
                <tr><td colspan="6" class="text-muted">No orders found</td></tr>
                {% endfor %}
            </tbody>
            <tfoot class="table-secondary fw-bold">
                <tr>
                    <td colspan="4">Totals</td>
                    <td>{{ total_orders_sales }}</td>
                    <td>{{ total_orders }} Orders</td>
                </tr>
            </tfoot>
        </table>
    </div>

    <!-- Ø¬Ø¯ÙˆÙ„ Extra Expenses (Ø§Ù„Ù†Ø³Ø±ÙŠØ§Øª ÙˆØ§Ù„ØªØ¨Ø³) -->
    <div class="card shadow p-3 mt-5">
        <h4 class="fw-bold mb-3">ğŸ“’ Ø§Ù„Ù†Ø³Ø±ÙŠØ§Øª ÙˆØ§Ù„ØªØ¨Ø³</h4>
        <form method="get" class="mb-3 d-flex gap-2">
            <input type="date" name="exp_start" value="{{ exp_start }}" class="form-control" style="max-width:200px;">
            <input type="date" name="exp_end" value="{{ exp_end }}" class="form-control" style="max-width:200px;">
            <button type="submit" class="btn btn-primary">ğŸ” Filter</button>
            <a href="{% url 'monthly_closing_list' %}" class="btn btn-secondary">â™»ï¸ Reset</a>
        </form>

        <div class="alert alert-info d-flex justify-content-between">
            <div><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ø³Ø±ÙŠØ§Øª:</strong> {{ total_nesrayat }} Ø¬</div>
            <div><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ¨Ø³:</strong> {{ total_tips }} Ø¬</div>
            <div><strong>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ:</strong> {{ total_all_exp }} Ø¬</div>
        </div>

        <table class="table table-bordered table-striped text-center">
            <thead class="table-dark">
                <tr>
                    <th>#</th>
                    <th>Ø§Ù„Ø¨Ù†Ø¯</th>
                    <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                    <th>Ù…Ù„Ø§Ø­Ø¸Ø©</th>
                    <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                </tr>
            </thead>
            <tbody>
                {% for exp in expenses %}
                <tr>
                    <td>{{ forloop.counter }}</td>
                    <td>{{ exp.get_category_display }}</td>
                    <td>{{ exp.amount }}</td>
                    <td>{{ exp.note|default:"-" }}</td>
                    <td>{{ exp.created_at|date:"Y-m-d H:i" }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" class="text-muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

</div>

{% endblock %}
