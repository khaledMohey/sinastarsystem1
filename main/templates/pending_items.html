{% extends "base.html" %}
{% load static %}
{% block content %}

<div class="d-flex justify-content-between align-items-center mb-3">
Â  <div>
Â  Â  {% if role == 'barista' %}
Â  Â  Â  <a href="?type=barista" class="btn btn-info btn-sm active">â˜• Ø¨Ø§Ø±ÙŠØ³ØªØ§</a>
Â  Â  {% elif role == 'mat3am' %}
Â  Â  Â  <a href="?type=mat3am" class="btn btn-warning btn-sm active">ğŸ½ï¸ Ù…Ø·Ø¹Ù…</a>
Â  Â  {% elif role in 'admin cashier' %}
Â  Â  Â  <a href="{% url 'pending_items' %}" class="btn btn-secondary btn-sm {% if not inv_type %}active{% endif %}">Ø§Ù„ÙƒÙ„</a>
Â  Â  Â  <a href="?type=barista" class="btn btn-info btn-sm {% if inv_type == 'barista' %}active{% endif %}">â˜• Ø¨Ø§Ø±ÙŠØ³ØªØ§</a>
Â  Â  Â  <a href="?type=mat3am" class="btn btn-warning btn-sm {% if inv_type == 'mat3am' %}active{% endif %}">ğŸ½ï¸ Ù…Ø·Ø¹Ù…</a>
Â  Â  Â  <a href="?type=canteen" class="btn btn-secondary btn-sm {% if inv_type == 'canteen' %}active{% endif %}">ğŸ¥ª ÙƒØ§Ù†ØªÙŠÙ†</a>
Â  Â  Â  <a href="?type=7alak" class="btn btn-primary btn-sm {% if inv_type == '7alak' %}active{% endif %}">ğŸ’ˆ Ø­Ù„Ø§Ù‚</a>
Â  Â  Â  <a href="?type=shesha" class="btn btn-danger btn-sm {% if inv_type == 'shesha' %}active{% endif %}">ğŸ’¨ Ø´ÙŠØ´Ø©</a>
Â  Â  Â  <a href="{% url 'waiter_items' %}" class="btn btn-success btn-sm float-end">ğŸ‘¨â€ğŸ³ ØµÙØ­Ø© Ø§Ù„ÙˆÙŠØªØ±</a>
Â  Â  {% endif %}
Â  </div>

Â  Â  <button id="enableSound" class="btn btn-success btn-sm">ğŸ”” ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª</button>
</div>

<div id="orders-container">
{% for data in orders %}
Â  <div class="card mb-3 bg-dark text-light order-card" id="order-{{ data.order.id }}">
Â  Â  <div class="card-header">
Â  Â  Â  <strong>#{{ data.order.id }}</strong>
Â  Â  Â  {% if data.order.order_type == "cafe" %}
Â  Â  Â  Â  <span class="badge bg-info">In Cafe</span> ğŸª‘ Table {{ data.order.table_number }}
Â  Â  Â  {% elif data.order.order_type == "takeaway" %}
Â  Â  Â  Â  <span class="badge bg-warning text-dark">Takeaway</span>
Â  Â  Â  {% elif data.order.order_type == "qeta3" %}
Â  Â  Â  Â  <span class="badge bg-secondary">ğŸ¢ Ù‚Ø·Ø§Ø¹</span>
Â  Â  Â  {% endif %}
Â  Â  </div>
Â  Â  <div class="card-body p-0">
Â  Â  Â  <table class="table table-bordered table-striped table-dark m-0">
Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  <th>Item</th>
Â  Â  Â  Â  Â  Â  <th>Qty</th>
Â  Â  Â  Â  Â  Â  <th>Ù‚Ø³Ù…</th>
Â  Â  Â  Â  Â  Â  <th>âœ”ï¸</th>
Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  </thead>
Â  Â  Â  Â  <tbody>
Â  Â  Â  Â  Â  {% for item in data.items %}
Â  Â  Â  Â  Â  Â  <tr id="item-{{ item.id }}">
Â  Â  Â  Â  Â  Â  Â  <td>{{ item.menuitem.name }}</td>
Â  Â  Â  Â  Â  Â  Â  <td>{{ item.quantity }}</td>
Â  Â  Â  Â  Â  Â  Â  <td>
Â  Â  Â  Â  Â  Â  Â  Â  {% if item.menuitem.section == "barista" %} â˜• Ø¨Ø§Ø±ÙŠØ³ØªØ§
Â  Â  Â  Â  Â  Â  Â  Â  {% elif item.menuitem.section == "mat3am" %} ğŸ½ï¸ Ù…Ø·Ø¹Ù…
Â  Â  Â  Â  Â  Â  Â  Â  {% elif item.menuitem.section == "canteen" %} ğŸ¥ª ÙƒØ§Ù†ØªÙŠÙ†
Â  Â  Â  Â  Â  Â  Â  Â  {% elif item.menuitem.section == "7alak" %} ğŸ’ˆ Ø­Ù„Ø§Ù‚
Â  Â  Â  Â  Â  Â  Â  Â  {% elif item.menuitem.section == "shesha" %} ğŸ’¨ Ø´ÙŠØ´Ø©
Â  Â  Â  Â  Â  Â  Â  Â  {% endif %}
Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  Â  <td>
Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-success btn-sm mark-done" data-id="{{ item.id }}" data-order="{{ data.order.id }}">âœ”ï¸ ØªÙ…</button>
Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  {% endfor %}
Â  Â  Â  Â  </tbody>
Â  Â  Â  </table>
Â  Â  </div>
Â  </div>
{% empty %}
Â  <p class="text-center">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ÙˆØ±Ø¯Ø±Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹ ğŸ‰</p>
{% endfor %}
</div>

<script>
function getCookie(name) {
Â  let cookieValue = null;
Â  if (document.cookie && document.cookie !== "") {
Â  Â  const cookies = document.cookie.split(";");
Â  Â  for (let i = 0; i < cookies.length; i++) {
Â  Â  Â  const cookie = cookies[i].trim();
Â  Â  Â  if (cookie.startsWith(name + "=")) {
Â  Â  Â  Â  cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
Â  Â  Â  Â  break;
Â  Â  Â  }
Â  Â  }
Â  }
Â  return cookieValue;
}
const csrftoken = getCookie("csrftoken");

// ====== Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØµÙˆØª ======
const audio = new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg");
audio.load();
let soundEnabled = false;

// ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª Ø¨Ø§Ù„Ø²Ø± ÙÙ‚Ø·
document.getElementById("enableSound").addEventListener("click", async () => {
Â  try {
Â  Â  await audio.play();
Â  Â  audio.pause();
Â  Â  audio.currentTime = 0;
Â  Â  soundEnabled = true;
Â  Â  const btn = document.getElementById("enableSound");
Â  Â  btn.textContent = "ğŸ”Š Ø§Ù„ØµÙˆØª Ù…ÙØ¹Ù„";
Â  Â  btn.classList.replace("btn-success", "btn-secondary");
Â  Â  btn.disabled = true;
Â  } catch (err) {
Â  Â  alert("âš ï¸ Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø¶ØºØ· Ø§Ù„Ø²Ø± Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù„Ù„Ø³Ù…Ø§Ø­ Ø¨ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª.");
Â  }
});

// ====== ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø£ÙˆØ±Ø¯Ø± ======
document.addEventListener("DOMContentLoaded", () => {
Â  document.querySelectorAll(".mark-done").forEach(btn => {
Â  Â  btn.addEventListener("click", () => {
Â  Â  Â  let itemId = btn.dataset.id;
Â  Â  Â  let orderId = btn.dataset.order;

Â  Â  Â  fetch(`/mark-item-done/${itemId}/`, {
Â  Â  Â  Â  method: "POST",
Â  Â  Â  Â  headers: {
Â  Â  Â  Â  Â  "X-CSRFToken": csrftoken,
Â  Â  Â  Â  Â  "X-Requested-With": "XMLHttpRequest"
Â  Â  Â  Â  },
Â  Â  Â  Â  body: JSON.stringify({})
Â  Â  Â  })
Â  Â  Â  .then(res => res.json())
Â  Â  Â  .then(data => {
Â  Â  Â  Â  if (data.success) {
Â  Â  Â  Â  Â  document.getElementById(`item-${itemId}`).remove();
Â  Â  Â  Â  Â  let tbody = document.querySelector(`#order-${orderId} tbody`);
Â  Â  Â  Â  Â  if (tbody.children.length === 0) {
Â  Â  Â  Â  Â  Â  document.getElementById(`order-${orderId}`).remove();
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  });
Â  });
});

// ====== ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£ÙˆØ±Ø¯Ø±Ø§Øª ======
let lastOrderIds = Array.from(document.querySelectorAll(".order-card")).map(el => el.id);

function checkNewOrders() {
Â  let url = window.location.pathname + window.location.search;
Â  fetch(url, { headers: { "X-Requested-With": "XMLHttpRequest" } })
Â  Â  .then(res => res.text())
Â  Â  .then(html => {
Â  Â  Â  const parser = new DOMParser();
Â  Â  Â  const doc = parser.parseFromString(html, "text/html");
Â  Â  Â  const newCards = doc.querySelectorAll(".order-card");
Â  Â  Â  const newOrderIds = Array.from(newCards).map(el => el.id);
Â  Â  Â  const newOnes = newOrderIds.filter(id => !lastOrderIds.includes(id));

Â  Â  Â  if (newOnes.length > 0) {
Â  Â  Â  Â  document.querySelector("#orders-container").innerHTML =
Â  Â  Â  Â  Â  doc.querySelector("#orders-container").innerHTML;

Â  Â  Â  Â  // ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª Ù„Ùˆ Ù…ÙØ¹Ù„
Â  Â  Â  Â  if (soundEnabled) {
Â  Â  Â  Â  Â  audio.currentTime = 0;
Â  Â  Â  Â  Â  audio.play().catch(err => console.log("âŒ Ù„Ù… ÙŠØªÙ… ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª:", err));
Â  Â  Â  Â  }

Â  Â  Â  Â  // ÙˆÙ…ÙŠØ¶ Ù„Ù„Ø£ÙˆØ±Ø¯Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙˆØ¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø±Ø³Ø§Ù„Ø©
Â  Â  Â  Â  const urlParams = new URLSearchParams(window.location.search);
Â  Â  Â  Â  const sectionType = urlParams.get('type');
Â  Â  Â  Â  let sectionName = '';

Â  Â  Â  Â  if (sectionType === 'barista') sectionName = 'â˜• Ø§Ù„Ø¨Ø§Ø±ÙŠØ³ØªØ§';
Â  Â  Â  Â  else if (sectionType === 'mat3am') sectionName = 'ğŸ½ï¸ Ø§Ù„Ù…Ø·Ø¹Ù…';
Â  Â  Â  Â  else if (sectionType === 'canteen') sectionName = 'ğŸ¥ª Ø§Ù„ÙƒØ§Ù†ØªÙŠÙ†';
Â  Â  Â  Â  else if (sectionType === '7alak') sectionName = 'ğŸ’ˆ Ø§Ù„Ø­Ù„Ø§Ù‚';
Â  Â  Â  Â  else if (sectionType === 'shesha') sectionName = 'ğŸ’¨ Ø§Ù„Ø´ÙŠØ´Ø©';
        else sectionName = 'Ø¹Ø§Ù…';


Â  Â  Â  Â  newOnes.forEach(id => {
Â  Â  Â  Â  Â  const el = document.getElementById(id);
Â  Â  Â  Â  Â  if (el) {
Â  Â  Â  Â  Â  Â  el.style.animation = "flash 1s ease-in-out 3";
Â  Â  Â  Â  Â  Â  const orderNumber = id.replace("order-", "#");

Â  Â  Â  Â  Â  Â  // ğŸ”” Ø±Ø³Ø§Ù„Ø© ØªÙ†Ø¨ÙŠÙ‡ (Alert Notification)
Â  Â  Â  Â  Â  Â  alert(`ğŸ”” Ø£ÙˆØ±Ø¯Ø± Ø¬Ø¯ÙŠØ¯ Ù„Ù€ ${sectionName}! Ø±Ù‚Ù…: ${orderNumber}`);
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  }

Â  Â  Â  lastOrderIds = newOrderIds;
Â  Â  })
Â  Â  .catch(err => console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«:", err));
}

// ====== Ø£Ù†Ù…ÙŠØ´Ù† Ø§Ù„ÙˆÙ…ÙŠØ¶ ======
const style = document.createElement("style");
style.textContent = `
@keyframes flash {
Â  0% { box-shadow: 0 0 0px #00ff00; }
Â  50% { box-shadow: 0 0 20px #00ff00; }
Â  100% { box-shadow: 0 0 0px #00ff00; }
}
`;
document.head.appendChild(style);

// ====== ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ ======
setInterval(checkNewOrders, 7000);
</script>

{% endblock %}